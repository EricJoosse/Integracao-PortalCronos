Manual Upgrade dos Ambientes de Produção de 2.8.5 para 3.0.0 
============================================================

No dia antes do upgrade:
========================
1. (i)  Perguntar Leão se tem uma cotação de teste pronta e preparada para testar a Marizpan amanhã pois 
        amanhã a gente não pode parar a integração da Marizpan em produção muito tempo 
        
   (ii) Perguntar Leão se ele mudou a senha de ws-marizpan após a cópia da base de Produção para 
        a base de Homologação
        
   (iii) Perguntar Bernardino se já tem uma base da Atacamax; 
         (a). No caso, solicitar os seguintes dados: 
              Qual é o endereço IP, SID/alias, porta, usuário e senha do banco Firebird de produção? 
              A porta é a porta "default" (3050)? 
       		  O usuário do banco Firebird pode ser um usuário que tem apenas privilêgio para consulta, 
       		  pois o Portal Cronos precisa apenas consultar o estoque e os preços dos produtos 
       		  e alguns dados dos clientes e não faz nenhuma alteração de nenhum dado na base do APS.
         
         (b). Caso contrário, dizer a Leão: 
              "Bernardino disse que ele ainda não tem a base da Atacamax.
               Assim não tem como instalar a versão Nuvem do Integrador, 
               pois para terminar a versão Nuvem, primeiro preciso debugar algumas coisas 
               com 2 fornecedores ofertando no mesmo servidor para saber como é que vou terminar a versão Nuvem."  


A. Upgrade de forma automatizada:
=================================

1. (i)  Gerar o Instalador no Eclipse.
   (ii) Zippar o Instalador para o arquivo PatchNuvem.zip 
        colocando a senha cronos@2019 no arquivo .zip para evitar uso indevido e hackeado. 
 
2. a. Verificar se o usuário logado é administrador ou administrator, 
      local ou da rede, abrindo e fechando cmd.exe (como administrador da rede ainda não foi testado).
      (Formaggio: user "techcorp")
	      
   b. Verificar se o usuário logado consegue abrir o botão "Environment Variables" 
      no Control Panel > System > Advanced System Settings > "Environment Variables".
      Caso contrário, provavelmente o usuário logado é de uma máquina virtual. 
      Pedir a TI conectar com um usuário administrador na máquina real debaixo da máquina virtual.
	      
   c. Nas opções do Windows Explorer marcar "Mostrar arquivos, pastas e unidades ocultas"  
      (foi testado no fornecedor Padeirão que não precisa desmarcar "Hide protected operating system files").
      Fechar e re-abrir o Windows Explorer. Senão re-abrir o Windows Explorer, 
      vai pensar indevidamente que não existe o dir C:\ProgramData\ por exemplo............. 
	
   d. Copiar o Instalador para o servidor do fornecedor.
   
	
3. (i)   Esperar até o processo atual do Integrador terminou.
   (ii)  Alterar o arquivo config da Marizpan de "P" para "H"
         e a senha de ws-marizpan no caso que Leão tinha alterada esta senha
   (iii) Backup do(s) arquivo(s) de configuração.
 
 
4. (i)   Primeiro verificar que o desinstalador não desinstala java!!!
         No caso, descomentar "goto SKIP_JRE"
   (ii)  Executar o Desinstalador como Administrador   
   (iii) Verificar se o Desinstalador apagou o menu de Windows, a Task Schedule, e os diretórios


5. Re-instalar Marizpan: 
	- Adicionar cliente novo "Marizpan"
	- !!!! AINDA NÃO copiar o conteúdo do backup do config da Marizpan para "Integração APS - Portal Cronos.Marizpan.properties"
	       para poder testar Marizpan e Atacamax ao mesmo tempo monitorando os 2 jvm´s executando ao mesmo tempo
	  
	- No Windows Explorer colar o seguinte endereço para o acompanhador da TI por enquanto não ver o menu de Windows: 
	  C:/ProgramData/Microsoft/Windows/Start Menu/Programs/Portal Cronos/Integrador APS Cloud/
	   
	- Alterar os seguintes ícones neste diretório manualmente: 
			- Ícone ....../res/AdicionarInstancia.ico
			- Ícone ....../res/RemoverInstancia.ico
			- Ícone ....../res/ConfiguraçõesInstância.ico

	- Verificar se o instalador já alterou automaticamente o dir C:\Arquivos de Programas PC\ para Hidden e System File.
	  Caso contrário, executando o seguinte na tela preta de DOS: 
	    	cd\
	    	attrib "Arquivos de Programas PC" +S +H	    
	  (é necessário para evitar cópias hackeadas e erradas dos arquivos de configuração, 
	   sem ter criado um Windows Task Schedule) 
	- 
		  (i)  No Windows Explorer alterar a opção para NÃO exibir arquivos de sistema operacional protegidos, 
		       (marcar "Hide protected operating system files")  
		       porém pode exibir hidden files, para todos os usuários inclusive cronostech 
		       (marcar "Show hidden files, folders, and drives")
		  (ii) Verificar se o diretório "Arquivos de Programas PC" ficou invisível no Windows Explorer como deveria

6. Adicionar instância nova "Atacamax"
		- !!!! AINDA NÃO configurar o .properties da Atacamax definitivamente
		       para poder testar Marizpan e Atacamax ao mesmo tempo monitorando os 2 jvm´s executando ao mesmo tempo
		- Já preparar um arquivo .properties de backup tudo pronto, apontando para o ambiente de Homologação
		  ("H" e a senha de ws-atacamax)
		- No Windows Explorer colar o seguinte endereço para o acompanhador da TI por enquanto não ver o menu de Windows: 
		  C:/ProgramData/Microsoft/Windows/Start Menu/Programs/Portal Cronos/Integrador APS Cloud/
	   	- Alterar os ícones neste diretório manualmente: 
			- Ícone ....../res/ConfiguraçõesInstância.ico


7. (i)   Abrir o taskmgr.exe primeiro e ordenar por nome e já scrollar para a letra "j" de java para java ficar no meio da tela  
   (ii)  Esperar um momento quando o job executou recentemente para dar tempo mexer e terminar antes da próxima rodada automática
   (iii) Copiar ao mesmo tempo os conteúdos dos 2 backups dos 2 configs da Marizpan para "Integração APS - Portal Cronos.Marizpan.properties"
         e da Atacamax para "Integração APS - Portal Cronos.Atacamax.properties"
   (iv)  Ficar monitorando os 2 jvm´s da Marizpan e da Atacamax na lista de processos de Windows 
         para testar se os 2 jvm´s realmente processaram ao mesmo tempo e se funcionam processando ao mesmo tempo
   (v)   Testar se o Integrador oferta os 2 fornecedores, sem misturas e interferências indevidas
   (vi)  Confirmar nos Debug.nmFornecedor.log´s se os 2 static constructors nos 2 jvm´s separados são independentes 
         pegando arqs .properties diferentes


8. Em todos os casos de servidores de PRODUÇÃO (não no servidor de Homologação do APS Cloud): 
     - Verificar a memória RAM livre no servidor do fornecedor (sem contar meu JVM).
		    - Preencher isso no f[i].MemoriaRamLivre = "" no FornecedorRepositorio   
	 - Observação: no servidor de monitoramento o serviço + JVM ocupa 60 MB de memória
	 

9. Em todos os casos: 
     - Acompanhar 15 minutos se o Integrador começa executar automaticamente
     
10. (i)   Atualizar a versão do .jar no arquivo "FornecedorRepositorio.java" para o fornecedor que foi atualizado
    (ii)  Compilar o arquivo .jar
    (iii) Atualizar o arquivo .jar no servidor de monitoramento (não precisa atualizar o servidor do fornecedor)
          esperando o processamento atual terminar primeiro
   
11. Após todos os testes, alterar o arquivo config da Marizpan de volta de "H" para "P"
    e a senha de ws-marizpan no caso que Leão tinha alterada esta senha

12. Enviar o email no Appendix abaixo para Leão e Bernardino. 
 
 
B. Upgrade de forma manual:
===========================

1. (i)  Apenas no caso do servidor do monitoramento:
		 - Conectar como cronostech
	     - No Windows Explorer alterar a opção para exibir arquivos de sistema 
	       (desmarcar "Hide protected operating system files") temporariamente

	(ii) Em todos os servidores dos fornecedores:
	      - Verificar se o usuário logado é administrador ou administrator, 
	        local ou da rede, abrindo e fechando cmd.exe (como administrador da rede ainda não foi testado).
	        (Formaggio: user "techcorp")
	      

2. Fazer exatamente na seguinte sequência:
   (i)   Em todos os casos exceto JR Distribuição / Windows 10:
         Verificar se o arquivo .bat e o .jar atual estão em uso: 
         verificar o horário da última e da próxima execução no Task Scheduler 
         e verificar no taskmgr.exe se o JRE está rodando ainda. 
         Esperar até o JRE terminou.
   
   (ii)  Em todos os casos (incluindo no caso JR Distribuição / Windows 10):
 		   - Adicionar "exit" seguida por uma linha em branco no início do arquivo 
 		     Job15a15minOfertamentoJava_Windows.bat no servidor do fornecedor. 
 		     (NÃO renomear Job15a15minOfertamentoJava_Windows.bat para evitar que o Scheduler 
              possivelmente se perde comprometendo os derrubamentos automáticos dos JRE´s travados)

   (iii) Apenas no caso de instalação no servidor da JR Distribuição (Windows 10):
	        a. Primeiro verificar no diretório C:\ProgramData\PortalCronos\Logs\Local\ 
	           se o Integrador está ofertando no momento e ficar esperando até ele terminar 
	           o último passo (a atualização do arquivo TemposExecução.log)
 
		    b. Matar o processo JRE 1.8.0_92
		 		 
		   
3. (i)  Copiar o arquivo novo integr-fornecedor-3.0.0.jar do instalador para o servidor do fornecedor.
   (ii) Apagar a versão anterior integr-fornecedor-*.*.*.jar.
 
4. Em todos os casos:
   (i) Atualizar os seguintes arquivos no servidor do fornecedor:
		- /bin/Versao.bat 
		- /bin/CaminhoJRE.bat
		- /bin/IsAmbienteNuvem.bat
		- /bin/ComponenteTestador.bat
		- /bin/VerificarUsuarioAdministrador.bat
		- Job15a15minOfertamentoJava_Windows.bat 
			- Re-adicionar "exit" seguida por uma linha em branco no início do arquivo 
		- Desinstalar_Integração_Fornecedor_PortalCronos.bat
		- AbrirConfigFornecedor.bat
		- TestadorUnitario.bat
				
   (ii) Gravar 0 ou 1 no arquivo /bin/IsAmbienteNuvem.bat + linebreak depois do 0 / 1	
 
5. Apenas no caso do APS Cloud: 
	- Copiar do projeto Eclipse para o servidor do APS Cloud:
		- AdicionarFornecedorNuvem.bat
		- RemoverFornecedorNuvem.bat
		- conf/TemplateNuvemAPS.properties
		- res/*.ico
	- Apagar o Task Schedule atual
	- Alterar o arquivo config da Marizpan de "P" para "H"
	  e a senha de ws-marizpan no caso que Leão tinha alterada esta senha
	- Backup do arquivo config .properties da Marizpan
	- Apagar o arquivo "conf/Integração Fornecedor - Portal Cronos.properties"
	- No Windows Explorer colar o seguinte endereço para o acompanhador da TI por enquanto 
	  não ver o menu de Windows: 
	      C:/ProgramData/Microsoft/Windows/Start Menu/Portal Cronos/
	  Se não existir, usar o seguinte endereço:
	      C:/ProgramData/Microsoft/Windows/Iniciar/Portal Cronos/
	- Neste diretório remover o atalho "Manual Manutenção TI" por enquanto
	- Neste diretório adicionar o subdir novo "Integrador APS Cloud/WinThor Cloud/..."
	- Neste subdiretório:
		- Criar o seguinte atalho:
			- "C:\Arquivos de Programas PC\AdicionarFornecedorNuvem.bat"
			- Renomear para "Adicionar Instância"
			- Ícone ....../res/AdicionarInstancia.ico
		- Criar o seguinte atalho:
			- "C:\Arquivos de Programas PC\RemoverFornecedorNuvem.bat"
			- Renomear para "Remover Instância"
			- Ícone ....../res/RemoverInstancia.ico
	- Adicionar cliente novo "Marizpan"
		- !!!! AINDA NÃO copiar o conteúdo do backup do config da Marizpan para "Integração APS - Portal Cronos.Marizpan.properties"
		       para poder testar Marizpan e Atacamax ao mesmo tempo monitorando os 2 jvm´s executando ao mesmo tempo
	- Copiar o conteúdo do backup do config da Marizpan para "Integração APS - Portal Cronos.Marizpan.properties"
	- No diretório C:/ProgramData/Microsoft/Windows/Start Menu/Portal Cronos/Integrador APS Cloud/:
		- Verificar se o seguinte atalho foi criado pela tela "Adicionar Instância":
		???????????????????????	- "C:\Arquivos de Programas PC\Integração Fornecedor - Portal Cronos\conf\Integração APS - Portal Cronos.Marizpan.properties"
			- Atalho renomeado para "Configurações Marizpan"
			- Ícone alterado para ....../res/ConfiguraçõesInstância.ico
		- Caso contrário, fazer isso na mão
	- Alterar o dir C:\Arquivos de Programas PC\ para Hidden e System File, executando o seguinte 
	  na tela preta de DOS: 
	    	cd\
	    	attrib "Arquivos de Programas PC" +S +H	    
	  (é necessário para evitar cópias hackeadas e erradas dos arquivos de configuração, 
	   sem ter criado um Windows Task Schedule) 
	- 
		  (i)  No Windows Explorer alterar a opção para NÃO exibir arquivos de sistema operacional protegidos, 
		       (marcar "Hide protected operating system files")  
		       porém pode exibir hidden files, para todos os usuários inclusive cronostech 
		       (marcar "Show hidden files, folders, and drives")
		  (ii) Verificar se o diretório "Arquivos de Programas PC" ficou invisível no Windows Explorer como deveria
	- Adicionar instância nova "Atacamax"
		- !!!! AINDA NÃO configurar o .properties da Atacamax definitivamente
		       para poder testar Marizpan e Atacamax ao mesmo tempo monitorando os 2 jvm´s executando ao mesmo tempo
		- Já preparar um arquivo .properties de backup tudo pronto, apontando para o ambiente de Homologação 
		  ("H" e a senha de ws-atacamax)
	- No menu de Windows "Iniciar" > "Portal Cronos" > "Integrador APS Cloud":
		- Verificar se o seguinte atalho foi criado pela tela "Adicionar Instância":
		???????????????	- "C:\Arquivos de Programas PC\Integração Fornecedor - Portal Cronos\conf\Integração APS - Portal Cronos.Atacamax.properties"
			- Atalho renomeado para "Configurações Atacamax"
			- Ícone alterado para ....../res/ConfiguraçõesInstância.ico
		- Caso contrário, fazer isso na mão

	- (i)   Abrir o taskmgr.exe primeiro e ordenar por nome e já scrollar para a letra "j" de java para java ficar no meio da tela  
      (ii)  Esperar um momento quando o job executou recentemente para dar tempo mexer e terminar antes da próxima rodada automática
      (iii) Copiar ao mesmo tempo os conteúdos dos 2 backups dos 2 configs da Marizpan para "Integração APS - Portal Cronos.Marizpan.properties"
            e da Atacamax para "Integração APS - Portal Cronos.Atacamax.properties"
      (iv)  Ficar monitorando os 2 jvm´s da Marizpan e da Atacamax na lista de processos de Windows 
            para testar se os 2 jvm´s realmente processaram ao mesmo tempo e se funcionam processando ao mesmo tempo
      (v)   Testar se o Integrador oferta os 2 fornecedores, sem misturas e interferências indevidas
      (vi)  Confirmar nos Debug.nmFornecedor.log´s se os 2 static constructors nos 2 jvm´s separados são independentes 
            pegando arqs .properties diferentes

    - Após todos os testes, alterar o arquivo config da Marizpan de volta de "H" para "P"
      e a senha de ws-marizpan no caso que Leão tinha alterada esta senha


6. Em todos os casos de servidores de PRODUÇÃO (não no servidor de Homologação do APS Cloud): 
     - Verificar a memória RAM livre no servidor do fornecedor (sem contar meu JVM).
		    - Preencher isso no f[i].MemoriaRamLivre = "" no FornecedorRepositorio   
	 - Observação: no servidor de monitoramento o serviço + JVM ocupa 60 MB de memória
	 
 
7. Remover "exit" e a linha em branco no início do arquivo Job15a15minOfertamentoJava_Windows.bat
   no servidor do fornecedor (Sempre como último passo no AnyDesk para forçar 100 % conclusão do upgrade).

8. Em todos os casos: 
     - Acompanhar 15 minutos se o Integrador começa executar automaticamente
     
9. Apenas no caso do servidor do monitoramento: 
     (i)  No Windows Explorer voltar a opção para não exibir arquivos de sistema 
          (marcar "Hide protected operating system files")
     (ii) Fechar o Windows Explorer e abrir novamente
     
     
10. (i)   Atualizar a versão do .jar no arquivo "FornecedorRepositorio.java" para o fornecedor que foi atualizado
    (ii)  Compilar o arquivo .jar
    (iii) Atualizar o arquivo .jar no servidor de monitoramento (não precisa atualizar o servidor do fornecedor)
          esperando o processamento atual terminar primeiro
   
11. Enviar o email no Appendix abaixo para Leão e Bernardino. 
 

C. Appendix: Email de conclusão:
================================

- Substituir <i> e </i> em 2 lugares
- Assunto: Manualzinho versão Nuvem do Integrador APS Cloud/PCronos
- Mensagem:
  
Leão, Bernardino, 
 
  a versão Nuvem do Integrador APS Cloud/PCronos foi instalada com sucesso. 
Na versão nuvem não existe mais o diretório de configuração ("<i>C:\Arquivos de Programas PC\Integração Fornecedor - Portal Cronos\conf\</i>") 
e também não existem mais os arquivos de configuração ("<i>xxxxx.properties</i>"),  
pois simplesmente um "loop" sobre todos os arquivos de configuração no diretório não vai dar certo. 
Então para adicionar um fornecedor/cliente no Integrador não é para copiar mais um arquivo de configuração 
(fornecedor do ponto de vista do Portal, cliente do ponto de vista do APS Cloud).
 
Ao invés disso tem agora "instâncias" do Integrador, uma para cada empresa integrada. 
Estas instâncias se encontram no menu de Windows: "Iniciar" > "Portal Cronos" > "Integrador APS Cloud". 
Para editar as configurações de uma empresa cliente é só clicar na instância desejada.  
Também tem os botões novos "Adicionar Instância" e "Remover Instância" no mesmo menu de Windows. 
O uso do menu de Windows foi uma solução rápida e provisória que funciona 100 % pelo menos com o atual Windows Server 2008. 
 
Se quiser saber porque um simples "loop" sobre todos os arquivos de configuração no diretório não vai dar certo, veja abaixo os motivos: 
   1. O Integrador roda de 15 a 15 minutos. No futuro a gente vai adicionar 50 ou mais fornecedores/clientes 
      então um processo síncrono levaria mais de 15 minutos. Então para cada fornecedor/cliente deve ter 
      um processo asíncrono, quer dizer uma "instância" do Integrador; 
 
  2. Se tivesse um "loop" síncrono e se algum fornecedor/cliente travar o Integrador, 
      este fornecedor/cliente travaria todos os outros fornecedores/clientes;
 
  3. Se tivesse um "loop" síncrono, o risco de interferência indevida aumenta. 
      Não pode acontecer por exemplo que o Integrador envia ofertas para a Marizpan no Portal Cronos 
      usando os preços ou outros dados da Atacamax; 
 
Atc,
Eric
